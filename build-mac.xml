<project name="moai-staging" default="build-all">

    <!-- ================================================================ -->
    <!-- macros -->
    <!-- ================================================================ -->
	<macrodef name="build">
		<attribute name="configuration"/>
		<attribute name="sdk"/>
		<sequential>
            <exec executable="xcodebuild" dir="xcode" failonerror="false" errorproperty="xcodebuild.error" output="xcode/xcodebuild.cc.output">
                <arg line="-target Moai -configuration @{configuration} -sdk @{sdk} build"/>
            </exec>
		</sequential>
	</macrodef>

	<macrodef name="parse-errors">
		<attribute name="contextSize"/>
        <attribute name="errorTag"/>
		<sequential>
            <exec executable="/bin/bash" dir="../../" outputproperty="parsed.errors">
                <arg value="config-parse-errors.sh"/>
                <arg value="@{contextSize}"/>
                <arg value="@{errorTag}"/>
            </exec>
            <echo message="${parsed.errors}"/>
		</sequential>
	</macrodef>
	
    <!-- ================================================================ -->
    <!-- build -->
    <!-- ================================================================ -->
    <target name="build-all" depends="build-dist-device, build-dist-sim, build-debug-device, build-debug-sim, output-errors"/>

    <target name="build-dist-device" unless="xcodebuild.error">
        <build configuration="Distribution" sdk="iphoneos"/>
	</target>

    <target name="build-dist-sim" unless="xcodebuild.error">
        <build configuration="Distribution" sdk="iphonesimulator" unless="xcodebuild.error"/>
	</target>
    
    <target name="build-debug-device" unless="xcodebuild.error">
		<build configuration="Debug" sdk="iphoneos" unless="xcodebuild.error"/>
	</target>
    
    <target name="build-debug-sim" unless="xcodebuild.error">
		<build configuration="Debug" sdk="iphonesimulator"/>
	</target>
    
    <!-- ================================================================ -->
    <!-- output errors -->
    <!-- ================================================================ -->
	<target name="output-errors" if="xcodebuild.error">
        <parse-errors errorTag="error:" contextSize="1"/>
	</target>
</project>